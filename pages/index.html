<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - CFA Leadership Development</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">
    <link rel="stylesheet" href="../styles/styles.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../database/config.js"></script>
</head>
<body>
    <div class="container">
        <div class="login-card">
            <div class="card-header">
                <div class="logo">
                    <img src="../assets/CFA_CSymbol_Circle_Red_PMS.webp" alt="CFA Logo" width="60" height="60">
                    <h1>CFA Leadership Development</h1>
                </div>
                <p>Sign in to access your leadership development portal</p>
            </div>
            
            <div class="card-body">
                <form class="signin-form" id="signinForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </form>
                
                <div class="demo-section">
                    <p>Demo Credentials:</p>
                    <div class="demo-buttons">
                        <button type="button" class="btn btn-secondary" id="demoUserBtn">
                            <i class="fas fa-user"></i>
                            User Login
                        </button>
                        <button type="button" class="btn btn-secondary" id="demoAdminBtn">
                            <i class="fas fa-crown"></i>
                            Admin Login
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize default users if localStorage is empty or needs updating
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Login page loaded');
            
            // Initialize users (don't clear existing data when navigating)
            console.log('Initializing users...');
            
            // Create default users with usernames instead of emails
            const defaultUsers = [
                {
                    fullName: 'Admin User',
                    username: 'admin',
                    password: 'admin123',
                    role: 'Admin',
                    status: 'active'
                },
                {
                    fullName: 'Lisa Wilson',
                    username: 'lisa',
                    password: 'password123',
                    role: 'Supervisor',
                    status: 'active'
                },
                {
                    fullName: 'Test User 456',
                    username: 'test456',
                    password: '123456',
                    role: 'Team Member',
                    status: 'active'
                }
            ];
            
            // Initialize users - prioritize localStorage for now due to RLS issues
            const existingUsers = localStorage.getItem('users');
            console.log('Initial localStorage users check:', existingUsers);
            if (!existingUsers) {
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                console.log('Default users initialized in localStorage:', defaultUsers.length);
                console.log('Default users data:', defaultUsers);
            } else {
                console.log('Existing users found in localStorage, preserving data');
                const parsedUsers = JSON.parse(existingUsers);
                console.log('Existing users count:', parsedUsers.length);
                console.log('Existing users data:', parsedUsers);
            }
            
            // Try to sync with database in background (non-blocking)
            try {
                const dbUsers = await window.dbService.getUsers();
                console.log('Database users response:', dbUsers);
                if (dbUsers && dbUsers.length > 0) {
                    console.log('Users loaded from database:', dbUsers.length);
                    // Store in localStorage for compatibility
                    localStorage.setItem('users', JSON.stringify(dbUsers));
                    console.log('Database users stored in localStorage');
                } else {
                    console.log('No users found in database, keeping localStorage users');
                }
            } catch (error) {
                console.log('Database sync failed, using localStorage only:', error.message);
            }
            
            // Clear any old authentication data
            localStorage.removeItem('userEmail');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            
            // Set up form submission
            const signinForm = document.getElementById('signinForm');
            if (signinForm) {
                signinForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Form submitted!');
                    
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    console.log('Login attempt:', { username: username, password: password });
                    
                    // Get users from localStorage
                    const usersData = localStorage.getItem('users');
                    console.log('Raw users data from localStorage:', usersData);
                    const users = JSON.parse(usersData || '[]');
                    console.log('Parsed users:', users);
                    console.log('Available users count:', users.length);
                    
                    users.forEach(function(user, index) {
                        console.log('User ' + index + ':', user);
                        console.log('  Username match: ' + (user.username === username));
                        console.log('  Password match: ' + (user.password_hash === btoa(password)));
                    });
                    
                    const user = users.find(function(u) {
                        return u.username === username && u.password_hash === btoa(password);
                    });
                    console.log('Found user:', user);
                    
                    if (user) {
                        // Store current user data in the format expected by other pages
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        localStorage.setItem('username', user.username);
                        localStorage.setItem('isLoggedIn', 'true');
                        
                        console.log('Login successful! Stored user data:');
                        console.log('  currentUser:', localStorage.getItem('currentUser'));
                        console.log('  username:', localStorage.getItem('username'));
                        console.log('  isLoggedIn:', localStorage.getItem('isLoggedIn'));
                        
                        console.log('Redirecting...');
                        
                        // Redirect based on role
                        if (user.role === 'Admin') {
                            window.location.href = 'user-dashboard.html';
                        } else {
                            window.location.href = 'user-dashboard.html';
                        }
                    } else {
                        console.log('No matching user found');
                        alert('Invalid username or password');
                    }
                });
            }
            
            // Set up demo user button
            const demoUserBtn = document.getElementById('demoUserBtn');
            if (demoUserBtn) {
                demoUserBtn.addEventListener('click', function() {
                    document.getElementById('username').value = 'lisa';
                    document.getElementById('password').value = 'password123';
                    console.log('Demo user credentials filled');
                });
            }
            
            // Set up demo admin button
            const demoAdminBtn = document.getElementById('demoAdminBtn');
            if (demoAdminBtn) {
                demoAdminBtn.addEventListener('click', function() {
                    document.getElementById('username').value = 'admin';
                    document.getElementById('password').value = 'admin123';
                    console.log('Demo admin credentials filled');
                });
            }
        });
    </script>
</body>
</html>
